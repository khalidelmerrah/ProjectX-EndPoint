name: ProjectX Build & Sign

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Bundle Executable with PyInstaller
      run: |
        # Bundling app.py as entry point
        # Including osqueryi.exe in the bin/ directory as required by OSQueryClient
        pyinstaller --noconfirm --onefile --windowed --name "ProjectX" --add-binary "bin/osqueryi.exe;bin" app.py

    - name: Upload Unsigned Artifact
      uses: actions/upload-artifact@v4
      id: upload-unsigned-artifact
      with:
        name: unsigned-artifact
        path: dist/ProjectX.exe

    - name: Submit Signing Request to SignPath.io
      # Casing MUST be 'SignPath' (capital S and P)
      uses: SignPath/github-action-submit-signing-request@v2
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
        project-slug: 'ProjectX'
        signing_policy_slug: 'release-signing'
        github-artifact-id: ${{ steps.upload-unsigned-artifact.outputs.artifact-id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        wait-for-completion: true
        output-artifact-directory: 'dist/signed'

    - name: Download OSQuery Binary
      run: |
        mkdir bin
        # Fetch the official osquery MSIs from the repository
        curl -L https://pkg.osquery.io/windows/osquery-5.10.2.msi -o osquery.msi
        # Extract the binary using msiexec without installing the full package
        msiexec /a osquery.msi /qb TARGETDIR=%CD%\temp_osquery
        # Move the standalone shell to the expected bin/ directory
        move "%CD%\temp_osquery\osquery\osqueryi.exe" "bin\osqueryi.exe"
        # Cleanup temporary files
        del osquery.msi
        rmdir /s /q temp_osquery

    - name: Bundle Executable with PyInstaller
      run: |
        # PyInstaller now finds the binary in the local bin/ folder
        pyinstaller --noconfirm --onefile --windowed --name "ProjectX" --add-binary "bin/osqueryi.exe;bin" app.py