name: ProjectX Build & Sign

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Fetch OSQuery Sidecar
      shell: pwsh
      run: |
        # Create expected directory structure
        New-Item -ItemType Directory -Force -Path bin
        
        # Download official MSI
        Invoke-WebRequest -Uri "https://pkg.osquery.io/windows/osquery-5.12.1.msi" -OutFile "osquery.msi"
        
        # Administrative extraction to temporary directory
        Start-Process msiexec.exe -Wait -ArgumentList "/a osquery.msi /qb TARGETDIR=$pwd\osq_temp"
        
        # Relocate binary to path expected by managers.py and PyInstaller
        Move-Item -Path "osq_temp\osquery\osqueryi.exe" -Destination "bin\osqueryi.exe" -Force
        
        # Cleanup
        Remove-Item -Path "osquery.msi"
        Remove-Item -Path "osq_temp" -Recycle -Force

    - name: Bundle Executable with PyInstaller
      run: |
        # Source-to-Destination syntax: "source;destination" for Windows
        pyinstaller --noconfirm --onefile --windowed --name "ProjectX" --add-binary "bin/osqueryi.exe;bin" app.py

    - name: Upload Unsigned Artifact
      uses: actions/upload-artifact@v4
      id: upload-unsigned-artifact
      with:
        name: unsigned-artifact
        path: dist/ProjectX.exe

    - name: Submit Signing Request to SignPath.io
      uses: SignPath/github-action-submit-signing-request@v2
      with:
        api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
        organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
        project-slug: 'ProjectX'
        signing_policy_slug: 'release-signing'
        github-artifact-id: ${{ steps.upload-unsigned-artifact.outputs.artifact-id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        wait-for-completion: true
        output-artifact-directory: 'dist/signed'